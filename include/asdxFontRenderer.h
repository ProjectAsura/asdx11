//-----------------------------------------------------------------------------
// File : asdxFontRenderer.h
// Desc : Font Renderer
// Copyright(c) Project Asura. All right reserved.
//-----------------------------------------------------------------------------
#pragma once

//-----------------------------------------------------------------------------
// Includes.
//-----------------------------------------------------------------------------
#include <cstdint>
#include <map>
#include <vector>
#include <d3d11.h>
#include <asdxRef.h>
#include <asdxMath.h>


namespace asdx {

///////////////////////////////////////////////////////////////////////////////
// Glyph structure
///////////////////////////////////////////////////////////////////////////////
struct Glyph
{
    int     OffsetX;    // 開始位置オフセット.
    int     OffsetY;    // ベースラインからのオフセット.
    int     Width;      // 横幅.
    int     Height;     // 縦幅.
    int     Advance;    // 次の文字位置まで(横方向).
    Vector2 UV0;        // 左上のUV座標.
    Vector2 UV1;        // 右下のUV座標.
};

///////////////////////////////////////////////////////////////////////////////
// Font class
//////////////////////////////////////////////////////////////////////////////
class Font
{
    //=========================================================================
    // list of friend classes and methods.
    //=========================================================================
    /* NOTHING */

public:
    //=========================================================================
    // public variables.
    //=========================================================================
    /* NOTHING */

    //=========================================================================
    // public methods.
    //=========================================================================

    //-------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //-------------------------------------------------------------------------
    Font();

    //-------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //-------------------------------------------------------------------------
    ~Font();

    //-------------------------------------------------------------------------
    //! @brief      バイナリをロードします.
    //! 
    //! @param[in]      pDevice     デバイスです.
    //! @param[in]      pContext    デバイスコンテキストです.
    //! @param[in]      path        ファイルパス.
    //! @retval true    ロードに成功.
    //! @retval false   ロードに失敗.
    //-------------------------------------------------------------------------
    bool Load(ID3D11Device* pDevice, ID3D11DeviceContext* pContext, const char* path);

    //-------------------------------------------------------------------------
    //! @brief      破棄処理を行います.
    //-------------------------------------------------------------------------
    void Term();

    //-------------------------------------------------------------------------
    //! @brief      ベースラインからの上方向の高さを取得します.
    //! 
    //! @return     ベースラインからの上方向の高さを返却します.
    //-------------------------------------------------------------------------
    int GetAscent() const;

    //-------------------------------------------------------------------------
    //! @brief      ベースラインからの下方向の高さを取得します.
    //! 
    //! @return     ベースラインからの下方向の高さを返却します.
    //-------------------------------------------------------------------------
    int GetDescent() const;

    //-------------------------------------------------------------------------
    //! @brief      行間を取得します.
    //-------------------------------------------------------------------------
    int GetLineGap() const;

    //-------------------------------------------------------------------------
    //! @brief      フォントスケールを取得します.
    //-------------------------------------------------------------------------
    float GetHeightScale() const;

    //-------------------------------------------------------------------------
    //! @brief      一行あたりの高さを取得します.
    //-------------------------------------------------------------------------
    int GetHeight() const;

    //-------------------------------------------------------------------------
    //! @brief      グリフを持つかどうかチェックします.
    //-------------------------------------------------------------------------
    bool HasGlyph(uint32_t code) const;

    //-------------------------------------------------------------------------
    //! @brief      グリフを取得します.
    //-------------------------------------------------------------------------
    Glyph GetGlyph(uint32_t code) const;

    //-------------------------------------------------------------------------
    //! @brief      テクスチャを取得します.
    //-------------------------------------------------------------------------
    ID3D11ShaderResourceView* GetSRV() const;

private:
    //=========================================================================
    // private variables.
    //=========================================================================
    int                                 m_Ascent;
    int                                 m_Descent;
    int                                 m_LineGap;
    float                               m_HeightScale;
    std::map<uint32_t, Glyph>           m_Glyphs;
    RefPtr<ID3D11Texture2D>             m_Texture;
    RefPtr<ID3D11ShaderResourceView>    m_SRV;

    //=========================================================================
    // private methods.
    //=========================================================================
    /* NOTHING */
};


///////////////////////////////////////////////////////////////////////////////
// FontRenderer class
///////////////////////////////////////////////////////////////////////////////
class FontRenderer
{
    //=========================================================================
    // list of friend classes and methods.
    //=========================================================================
    /* NOTHING */

public:
    //=========================================================================
    // public variables.
    //=========================================================================
    /* NOTHING */

    //=========================================================================
    // public methods.
    //=========================================================================

    //-------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //-------------------------------------------------------------------------
    FontRenderer();

    //-------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //-------------------------------------------------------------------------
    ~FontRenderer();

    //-------------------------------------------------------------------------
    //! @brief      初期化処理を行います.
    //-------------------------------------------------------------------------
    bool Init(ID3D11Device* pDevice, uint32_t maxSpriteCount, int w, int h);

    //-------------------------------------------------------------------------
    //! @brief      終了処理を行います.
    //-------------------------------------------------------------------------
    void Term();

    //-------------------------------------------------------------------------
    //! @brief      フォントを設定します.
    //-------------------------------------------------------------------------
    void SetFont(const Font* font);

    //-------------------------------------------------------------------------
    //! @brief      フォントを取得します.
    //-------------------------------------------------------------------------
    const Font* GetFont() const;

    //-------------------------------------------------------------------------
    //! @brief      カラーを設定します.
    //-------------------------------------------------------------------------
    void SetColor(float r, float g, float b, float a);

    //-------------------------------------------------------------------------
    //! @brief      カラーを設定します.
    //-------------------------------------------------------------------------
    void SetColor(const Vector4& color);

    //-------------------------------------------------------------------------
    //! @brief      カラーを取得します.
    //-------------------------------------------------------------------------
    Vector4 GetColor() const;

    //-------------------------------------------------------------------------
    //! @brief      スケールを設定します.
    //-------------------------------------------------------------------------
    void SetScale(float value);

    //-------------------------------------------------------------------------
    //! @brief      スケールを取得します.
    //-------------------------------------------------------------------------
    float GetScale() const;

    //-------------------------------------------------------------------------
    //! @brief      アウトラインフラグを設定します.
    //-------------------------------------------------------------------------
    void SetOutline(bool value);

    //-------------------------------------------------------------------------
    //! @brief      アウトラインフラグを取得します.
    //-------------------------------------------------------------------------
    bool GetOutline() const;

    //-------------------------------------------------------------------------
    //! @brief      アウターグローフラグを設定します.
    //-------------------------------------------------------------------------
    void SetOuterGlow(bool value);

    //-------------------------------------------------------------------------
    //! @brief      アウターグローフラグを取得します.
    //-------------------------------------------------------------------------
    bool GetOuterGlow() const;

    //-------------------------------------------------------------------------
    //! @brief      ドロップシャドウフラグを設定します.
    //-------------------------------------------------------------------------
    void SetDropShadow(bool value);

    //-------------------------------------------------------------------------
    //! @brief      ドロップシャドウフラグを取得します.
    //-------------------------------------------------------------------------
    bool GetDropShadow() const;

    //-------------------------------------------------------------------------
    //! @brief      スクリーンサイズを設定します.
    //-------------------------------------------------------------------------
    void SetScreenSize(int w, int h);

    //-------------------------------------------------------------------------
    //! @brief      スクリーンサイズを取得します.
    //-------------------------------------------------------------------------
    Vector2 GetScreenSize() const;

    //-------------------------------------------------------------------------
    //! @brief      描画を開始します.
    //-------------------------------------------------------------------------
    void Begin(ID3D11DeviceContext* pContext);

    //-------------------------------------------------------------------------
    //! @brief      文字列を描画します.
    //-------------------------------------------------------------------------
    void DrawString(int x, int y, const char* text);

    //-------------------------------------------------------------------------
    //! @brief      文字列を描画します.
    //-------------------------------------------------------------------------
    void DrawString(int x, int y, int z, const char* text);

    //-------------------------------------------------------------------------
    //! @brief      フォーマットを指定して文字列を描画します.
    //-------------------------------------------------------------------------
    void DrawFormat(int x, int y, const char* format, ...);

    //-------------------------------------------------------------------------
    //! @brief      フォーマットを指定して文字列を描画します.
    //-------------------------------------------------------------------------
    void DrawFormat(int x, int y, int z, const char* format, ...);

    //-------------------------------------------------------------------------
    //! @brief      描画を終了し，ドローコールを発行します.
    //-------------------------------------------------------------------------
    void End(ID3D11DeviceContext* pContext);


private:
    ///////////////////////////////////////////////////////////////////////////
    // Vertex structure
    ///////////////////////////////////////////////////////////////////////////
    struct Vertex
    {
        asdx::Vector3 Position;     //!< 位置座標です.
        asdx::Vector2 TexCoord;     //!< テクスチャ座標です.
        asdx::Vector4 Color;        //!< カラーです.
        uint8_t       Flags;        //!< フラグです.
    };

    //=========================================================================
    // private variables.
    //=========================================================================
    const Font* m_Font;
    float       m_Scale;
    Vector4     m_Color;
    uint32_t    m_MaxSpriteCount;
    uint32_t    m_SpriteCount;
    Vector2     m_ScreenSize;
    uint8_t     m_Flags;

    RefPtr<ID3D11VertexShader>  m_VS;
    RefPtr<ID3D11PixelShader>   m_PS;
    RefPtr<ID3D11Buffer>        m_VB;
    RefPtr<ID3D11Buffer>        m_IB;
    RefPtr<ID3D11Buffer>        m_CB;
    RefPtr<ID3D11InputLayout>   m_IL;
    std::vector<Vertex>         m_Vertices;

    //=========================================================================
    // private methods.
    //=========================================================================

    //-------------------------------------------------------------------------
    //! @brief      スプライトを追加します.
    //-------------------------------------------------------------------------
    void AddSprite(int x, int y, const Glyph& glyph);
};



} // namespace asdx
